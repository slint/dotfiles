## Uncomment to profile
# zmodload zsh/zprof

# Enable Powerlevel10k instant prompt.
source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"

# Zinit
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
source "${ZINIT_HOME}/zinit.zsh"
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

## Plugins
zinit ice depth=1; zinit light romkatv/powerlevel10k
zinit light zsh-users/zsh-syntax-highlighting
zinit light zsh-users/zsh-completions
zinit light zsh-users/zsh-autosuggestions

# Snippets (lazy-loaded to improve startup)
# oh-my-zsh libraries
zinit wait'1' lucid for OMZL::clipboard.zsh
zinit wait'1' lucid for OMZL::git.zsh
zinit wait'1' lucid for OMZL::async_prompt.zsh

# oh-my-zsh plugins - immediate loading
zinit snippet OMZP::common-aliases
zinit snippet OMZP::eza

# oh-my-zsh plugins (lazy-loaded)
zinit wait'2' lucid for OMZP::brew
zinit wait'2' lucid for OMZP::colored-man-pages
zinit wait'2' lucid for OMZP::extract
zinit wait'2' lucid for OMZP::gh
zinit wait'2' lucid for OMZP::git
zinit wait'2' lucid for OMZP::pip
zinit wait'2' lucid for OMZP::rust
zinit wait'2' lucid for OMZP::tmux
zinit wait'2' lucid for OMZP::command-not-found

dir="$HOME/.zsh-complete"
mkdir -p "$dir"
rg --generate complete-zsh > "$dir/_rg"

# Load completions
autoload -U compinit && compinit
zinit cdreplay -q

## Keybindings
bindkey -e
bindkey '^p' history-search-backward
bindkey '^n' history-search-forward
bindkey '^[[Z' reverse-menu-complete

# History
export HISTIGNORE="&:ls:ll:l:cd:[bf]g:exit:pwd:clear:mount:umount:[ \t]*"
export HISTFILESIZE=1000000000
export HISTSIZE=1000000000
export SAVEHIST=$HISTSIZE
export HISTDUP=erase
setopt appendhistory
setopt sharehistory
setopt hist_ignore_space
setopt hist_ignore_all_dups
setopt hist_save_no_dups
setopt hist_ignore_dups
setopt hist_find_no_dups

export LS_COLORS="$(vivid generate snazzy)"
export EXA_COLORS="da=1;34:uu=35:gu=35"

# Completion styling
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' menu select
zstyle ':completion:*' file-sort modification

# Disable some zsh weirdness
unsetopt autocd
unsetopt beep
unsetopt nomatch

# set language
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"
export LC_CTYPE="en_US.UTF-8"

## Tools

# atuin (SQLite-backed shell command history)
eval "$(atuin init zsh --disable-ctrl-r --disable-up-arrow)"
# FZF Integration
eval "$(fzf --zsh)"
# Zoxide
eval "$(zoxide init --cmd cd zsh)"

# Generate completions in background to avoid blocking startup
{
  rg --generate complete-zsh > "$dir/_rg" 2>/dev/null
  docker completion zsh > "$dir/_docker" 2>/dev/null
  _INVENIO_CLI_COMPLETE=source_zsh invenio-cli > "$dir/_invenio-cli" 2>/dev/null
  uv generate-shell-completion zsh > "$dir/_uv" 2>/dev/null
  ruff generate-shell-completion zsh > "$dir/_ruff" 2>/dev/null
  just --completions zsh > "$dir/_just" 2>/dev/null
  doggo completions zsh > "$dir/_doggo" 2>/dev/null
  gh completion --shell zsh > "$dir/_gh" 2>/dev/null
  oc completion zsh > "$dir/_oc" 2>/dev/null
} &!

# psql and pg_* commands
export PATH="/opt/homebrew/opt/libpq/bin:$PATH"

# iterm2 shell integration
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh" || true

# ruby...
rbenv() {
  eval "$(rbenv init - --no-rehash zsh)"
}
# Add RVM to PATH for scripting. Make sure this is the last PATH variable change.
export PATH="$PATH:$HOME/.rvm/bin"

# broot integration
source "$HOME/.config/broot/launcher/bash/br"

# fnm
FNM_PATH="$HOME/Library/Application Support/fnm"
if [ -d "$FNM_PATH" ]; then
  export PATH="$HOME/Library/Application Support/fnm:$PATH"
  eval "`fnm env`"
fi
# fnm completions (background)
{ fnm completions --shell zsh > "$dir/_fnm" 2>/dev/null } &!

# bun completions
source "$HOME/.bun/_bun"
# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

# Go binaries
export PATH="$HOME/go/bin:$PATH"
. "$HOME/.cargo/env"

# pnpm
export PNPM_HOME="$HOME/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end

# ImageMagick
export MAGICK_HOME=/opt/homebrew/opt/imagemagick/
export PATH="/opt/homebrew/opt/imagemagick/bin:$PATH"

## Aliases
source $HOME/.zsh_aliases

# powerlevel10k init (MUST be at the end!)
source ~/.p10k.zsh

## Uncomment to profile
# zprof
